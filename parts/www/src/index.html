<!DOCTYPE html>
<html lang="vi">
<head>
    <title>eFactory System</title>
    <link rel="icon" type="image/jpg" sizes="16x16" href="/python-webserver/favicon.png">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/python-webserver/stylesheet.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
</head>

<body>
    <!-- Header -->
    <div class="topbar">
        <div class="topbar-left">
            <img class="logo" src="/python-webserver/logo.png" alt="Logo">
            <h2>eFactory System</h2>
        </div>
        <div class="nav">
            <a href="/python-webserver?token=$(token)" class="chip">Home</a>
            <a href="/python-webserver/scada.html?token=$(token)" class="chip">SCADA</a>
            <a href="/python-webserver/mes.html?token=$(token)" class="chip">MES</a>
            <a href="/python-webserver/cloud.html?token=$(token)" class="chip">Cloud</a>
            <a href="/python-webserver/admin.html?token=$(token)" class="chip">Admin</a>
        </div>
    </div>

    <div class="stage">
        <!-- Left Top Cards (OEE + OBJ Moni) -->
        <div class="left-top">
            <div class="blank"></div>
            <div class="card dark">
                <ul class="oee-nav">
                    <li id="prev-factory">Previous</li>
                    <li id="factory-name">Factory A</li>
                    <li id="next-factory">Next</li>
                </ul>
            </div>
            <div class="card dark">
                <h3>MACHINE OEE</h3>
                <div class="oee-column">
                    <div class="oee-content">
                        <div class="oee-value" id="oee">--</div>
                        <ul class="oee-list">
                        <li><span class="label">Availability</span><span class="value" id="availability">--</span></li>
                        <li><span class="label">Performance</span><span class="value" id="performance">--</span></li>
                        <li><span class="label">Quality</span><span class="value" id="quality">--</span></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card">
                <h3>OBJECT PLACEMENT MONITORING</h3>
                <div class="object-grid">
                    <div class="obj-item">
                        <span class="servo-title">Servo A</span>    
                        <br/>Status<br >
                        <span id="servo1-status" class="badge"></span>
                    </div>
                    <div class="obj-item">
                        <span class="servo-title">Servo B</span>
                        <br/>Status<br/>
                        <span id="servo2-status" class="badge"></span>
                    </div>
                    <div class="obj-item">
                        <span class="servo-title">Sensor A</span>
                        <br/>Status<br/>
                        <span id="sensor1-status" class="badge"></span>
                    </div>
                    <div class="obj-item">
                        <span class="servo-title">Sensor B</span>
                        <br/>Status<br/>
                        <span id="sensor2-status" class="badge"></span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Left Bottom Card (Environment Moni) -->
        <div class="left-bottom">
            <div class="card">
                <h3>ENVIRONMENTAL MONITORING</h3>
                <div class="env-charts">
                <div class="gauge-container">
                    <canvas id="tempGauge"></canvas>
                    <div class="gauge-label">AVG. Temperature</div>
                </div>
                <div class="gauge-container">
                    <canvas id="humidityGauge"></canvas>
                    <div class="gauge-label">AVG. Humidity</div>
                </div>
                </div>
            </div>
        </div>

        <!-- Right Bottom Card (Running + Error Logs) -->
        <div class="right-bottom">
            <div class="card">
                <h3>RUNNING SCHEDULE</h3>
                <canvas id="scheduleChart"></canvas>
            </div>

            <div class="card">
                <h3>ERRORS LOG</h3>
                <section class="table_body">
                    <table>
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Description</th>
                                <th>Type</th>
                            </tr>
                        </thead>
                        <tbody>
                            $(error_rows)
                        </tbody>
                    </table>
                </section> 
            </div>
        </div>
    </div>

    <script>
        // Running Schedule
        new Chart(document.getElementById('scheduleChart'), {
            type: 'bar',
            data: {
                labels: ['01/01','02/01','03/01','04/01','05/01','06/01','07/01'],
                datasets: [{
                data: [20,12,22,21,19,10,23],
                backgroundColor: '#001B48'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                legend: { display: false },
                datalabels: {
                    anchor: 'end',
                    align: 'end',
                    color: '#001B48',
                    font: { weight: 'bold' }
                }
                },
                scales: {
                x: {
                    ticks: {
                    color: '#001B48',
                    font: { size: 12 }
                    }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                    color: '#001B48'
                    }
                }
                }
            },
            plugins: [ChartDataLabels]
        });

        // Gauge chart
        const gaugeText = {
            id: 'gaugeText',
            afterDraw(chart, args, options) {
            const {ctx, chartArea: {width, height}} = chart;
            ctx.save();
            ctx.font = 'bold 24px Arial';
            ctx.fillStyle = '#001B48';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            const value = chart.config.data.datasets[0].data[0];
            const unit = chart.config.options.plugins.gaugeUnit || ''; // l·∫•y unit
            ctx.fillText(value + unit, width / 2, height / 2);
            }
        };
        function createGauge(ctx, value, color, unit) {
            return new Chart(ctx, {
            type: 'doughnut',
            data: {
                datasets: [{
                data: [value, 100 - value],
                backgroundColor: [color, '#001B48'],
                borderWidth: 0
                }]
            },
            options: {
                cutout: '65%',
                plugins: {
                legend: { display: false },
                tooltip: { enabled: false },
                gaugeUnit: unit
                }
            },
            plugins: [gaugeText]
            });
        }

        function updateServoStatus(elementId, status) {
            console.log(`üîç [DEBUG] ${elementId} status raw:`, status); // Log ra console

            const badge = document.getElementById(elementId);
            if (!badge) {
                console.warn(`‚ö†Ô∏è [DEBUG] Element not found: ${elementId}`);
                return;
            }

            // N·∫øu PLC tr·∫£ v·ªÅ object ki·ªÉu { "Implicit_Enum__PLC_PRG__servoStatus1": "NORMAL" }
            if (typeof status === "object" && status !== null) {
                const firstKey = Object.keys(status)[0];
                status = status[firstKey];
                console.log(`‚úÖ Extracted status for ${elementId}:`, status);
            }

            // Chu·∫©n h√≥a
            status = String(status || "").toUpperCase();

            switch (status) {
                case "WORKING":
                case "NORMAL":
                    badge.textContent = "‚úì";
                    badge.className = "badge ok";
                    break;

                case "STANDBY":
                case "ERROR":
                case "FAULT":
                    badge.textContent = "!";
                    badge.className = "badge warn";
                    break;

                default:
                    badge.textContent = "‚úì";
                    badge.className = "badge ok";
                    console.warn(`‚ùì Unknown status for ${elementId}: "${status}"`);
                    break;
            }
        }


        const token = "$(token)"; // server render token
        const tempGauge = createGauge(document.getElementById('tempGauge'), 0, '#018ABE', '‚ÑÉ');
        const humidityGauge = createGauge(document.getElementById('humidityGauge'), 0, '#018ABE', '%');

        let currentFactory = "Factory A";

        // H√†m ƒë·ªçc data chung (ch·ªâ fetch 1 l·∫ßn)
        async function fetchData() {
            try {
                const res = await fetch(`/python-webserver/api/data?token=${token}`);
                const data = await res.json();
                return data;
            } catch (err) {
                console.error("Polling error:", err);
                return null;
            }
        }

        // Factory A
        async function updateDataFactoryA() {
            const data = await fetchData();
            if (!data) return;

            document.getElementById("availability").textContent = data.availabilityA;
            document.getElementById("performance").textContent = data.performanceA;
            document.getElementById("quality").textContent = data.qualityA;
            document.getElementById("oee").textContent = data.oeeA;

            // Gauges
            tempGauge.data.datasets[0].data = [data.temperatureA, 100 - data.temperatureA];
            tempGauge.update();
            humidityGauge.data.datasets[0].data = [data.humidityA, 100 - data.humidityA];
            humidityGauge.update();

            // Status
            updateServoStatus("servo1-status", data.driverStatus1);
            updateServoStatus("servo2-status", data.driverStatus2);
            updateServoStatus("sensor1-status", data.driverStatus1);
            updateServoStatus("sensor2-status", data.driverStatus2);
        }

        // Factory B
        async function updateDataFactoryB() {
            const data = await fetchData();
            if (!data) return;

            document.getElementById("availability").textContent = data.availabilityB;
            document.getElementById("performance").textContent = data.performanceB;
            document.getElementById("quality").textContent = data.qualityB;
            document.getElementById("oee").textContent = data.oeeB;

            // Gauges
            tempGauge.data.datasets[0].data = [data.temperatureB, 100 - data.temperatureB];
            tempGauge.update();
            humidityGauge.data.datasets[0].data = [data.humidityB, 100 - data.humidityB];
            humidityGauge.update();

            // Servo
            document.getElementById("servo3-value").textContent = data.servo3;
            document.getElementById("servo4-value").textContent = data.servo4;

            // Status
            updateServoStatus("servo3-status", data.driverStatus3);
            updateServoStatus("servo4-status", data.driverStatus4);
        }

        // H√†m ƒë·ªïi Factory
        function switchFactory() {
            const factoryNameEl = document.getElementById("factory-name");

            if (currentFactory === "Factory A") {
                currentFactory = "Factory B";
                factoryNameEl.textContent = "Factory B";
                updateDataFactoryB();
            } else {
                currentFactory = "Factory A";
                factoryNameEl.textContent = "Factory A";
                updateDataFactoryA();
            }
        }

        document.getElementById("prev-factory").addEventListener("click", switchFactory);
        document.getElementById("next-factory").addEventListener("click", switchFactory);

        // G·ªçi kh·ªüi t·∫°o
        updateDataFactoryA();

        // T√πy ch·ªçn: refresh ƒë·ªãnh k·ª≥
        setInterval(() => {
            if (currentFactory === "Factory A") updateDataFactoryA();
            else updateDataFactoryB();
        }, 500);
    </script>
</body>
</html>